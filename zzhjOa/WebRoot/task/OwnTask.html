<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>个人任务</title>

</head>
<body>
<div class="PagingBody">
    <h3>个 人 任 务</h3>
    <div class="buttonBar" id="buttonBarOwn">
        <a class="easyui-linkbutton" iconCls="icon-bg" plain="true" onclick="viewTask()">查看任务</a>
        <a class="easyui-linkbutton" iconCls="icon-edit" plain="true" onclick="changeSpeedDig()">修改任务进度</a>
    </div>
</div>
    <!--表格-->
	<table id="viewTeskDg"></table>
    <div id="viewTask" class="easyui-dialog" title="查看个人任务" closed=true>
        <ul>
            <li>
                <input type="hidden" name="userid">
            </li>
            <li style="height: 40px;margin-top: 20px">
                <div class="splitLi">
                    <span>任 务 主 题：</span>
                    <input type="text" name="taskTheme" readonly="readonly">
                </div>
                <div class="splitLi">
                    <span>发 &nbsp 布 &nbsp 人：</span>
                    <input type="text" name="userName" readonly>
                </div>
            </li>
            <li style="height: 40px">
                <div class="splitLi">
                    <span>发 布 日 期：</span>
                    <input type="text" name="taskDate" readonly>
                </div>
            </li>
            <li>
                <div class="splitLi" style="width: 102%">
                    <span>项 目 地 址：</span>
                    <input type="text" name="taskAddress" readonly style="width: 70%">
                </div>
            </li>
            <li style="height: 40px" >
                <div class="splitLi" style="width: 102%">
                    <span>委 托 单 位：</span>
                    <input type="text" name="entrustedUnit" readonly style="width: 70%">
                </div>
            </li>
            <li style="height: 40px">
                <div class="splitLi">
                    <span>委 &nbsp 托 &nbsp 人：</span>
                    <input type="text" name="client" readonly>
                </div>
                <div class="splitLi">
                    <span>委托人电话：</span>
                    <input type="text" name="clientPhone" readonly>
                </div>
            </li>
            <li style="height: 40px">
                <div class="splitLi">
                    <span>任务接收人：</span>
                    <input type="text" name="recipient" readonly>
                </div>
                <div class="splitLi">
                    <span>任务执行人：</span>
                    <input type="text" name="implement" readonly>
                </div>
            </li>
            <li style="height: 40px">
                <div class="splitLi">
                    <span>任务开始时间：</span>
                    <input type="text" name="implementDate" readonly>
                </div>
                <div class="splitLi">
                    <span>任务结束时间：</span>
                    <input type="text" name="successDate" readonly>
                </div>
            </li>
            <li>
                <span style="float: left">任 务 进 度：</span>
                <div id="speedTask" class="easyui-progressbar" style="width:71%; height: 38px"></div>
            </li>
            <li>
                <div class="splitLi">
                    <span>任 务 状 态：</span>
                    <input type="text" name="state" readonly >
                </div>
                <div class="splitLi">
                    <span>质 &nbsp 检 &nbsp 人：</span>
                    <input type="text" name="inspectionUser" readonly >
                </div>
            </li>
            <li style="height: 40px">
                <div class="splitLi">
                    <span>任 务 阶 段：</span>
                    <input type="text" name="taskPhase" readonly>
                </div>
                <div class="splitLi">
                    <span>质 量 检 测：</span>
                    <input type="text" name="inspection" readonly>
                </div>
            </li>
            <li>
                <span style="position: absolute;top: 29%;">任 务 内 容：</span>
                <textarea name="taskText" rows="7" cols="30" style="width: 70%;margin-left: 118px" readonly></textarea>
            </li>
            <li  class="Noprint" style="margin: 20px auto">
                <input type="button" class="button-task" value="确 认 接 收" onclick="acceptTask()" />
            </li>
            <li  class="Noprint" style="margin: 20px auto">
                <input type="button" class="button-task" value="任 务 打 印" onclick="ownTaskPrint()">
            </li>
            <li style="margin: 0 auto;display:none;" class="qz">
                <p style="width: 300px;text-align: left;float: right">签字：</p>
            </li>
        </ul>
    </div>
<div  id="viewTask2" class=" easyui-dialog " title="打印框" closed=true>
<div   class="PrintK"  style="height: auto">
    <ul>
       <li style="margin: 20px auto">
            <input type="button" class="button-task" value="确 认 打 印" onclick="Qprint()" />
        </li>
        <li style="margin: 20px auto">
            <input type="button" class="button-task" value="取 消 打 印" onclick="Uprint()">
        </li>
        <li style="margin-top:60px">
            <div class="splitLi">
                <span>任 务 主 题：</span>
                <input type="text" name="taskTheme" readonly="readonly">
            </div>
            <div class="splitLi">
                <span>发 &nbsp 布 &nbsp 人：</span>
                <input type="text" name="userName" readonly>
            </div>
        </li>
        <li>
            <div class="splitLi">
                <span>发 布 日 期：</span>
                <input type="text" name="taskDate" readonly>
            </div>
        </li>
        <li>
            <div class="splitLi" style="width: 102%">
                <span>项 目 地 址：</span>
                <input type="text" name="taskAddress" readonly style="width: 70%">
            </div>
        </li>
        <li  >
            <div class="splitLi" style="width: 102%">
                <span>委 托 单 位：</span>
                <input type="text" name="entrustedUnit" readonly style="width: 70%">
            </div>
        </li>
        <li>
            <div class="splitLi">
                <span>委 &nbsp 托 &nbsp 人：</span>
                <input type="text" name="client" readonly>
            </div>
            <div class="splitLi">
                <span>委托人电话：</span>
                <input type="text" name="clientPhone" readonly>
            </div>
        </li>
        <li>
            <div class="splitLi">
                <span>任务接收人：</span>
                <input type="text" name="recipient" readonly>
            </div>
            <div class="splitLi">
                <span>任务执行人：</span>
                <input type="text" name="implement" readonly>
            </div>
        </li>
        <li>
            <div class="splitLi">
                <span>任务开始时间：</span>
                <input type="text" name="implementDate" readonly>
            </div>
            <div class="splitLi">
                <span>任务结束时间：</span>
                <input type="text" name="successDate" readonly>
            </div>
        </li>
        <li>
            <span style="float: left">任 务 进 度：</span>
            <div id="speedTask2" class="easyui-progressbar" style="width:87%; height: 38px"></div>
        </li>
        <li>
            <div class="splitLi">
                <span>任 务 状 态：</span>
                <input type="text" name="state" readonly >
            </div>
            <div class="splitLi">
                <span>质 &nbsp 检 &nbsp 人：</span>
                <input type="text" name="inspectionUser" readonly >
            </div>
        </li>
        <li>
            <div class="splitLi">
                <span>任 务 阶 段：</span>
                <input type="text" name="taskPhase" readonly>
            </div>
            <div class="splitLi">
                <span>质 量 检 测：</span>
                <input type="text" name="inspection" readonly>
            </div>
        </li>
        <li>
            <span style="position: absolute;top: 29%;">任 务 内 容：</span>
            <textarea name="taskText" rows="7" cols="30" style="width: 87%;margin-left: 118px" readonly></textarea>
        </li>
     
        <li style="margin: 0 auto;display:none;" class="qz">
            <p style="width: 300px;text-align: left;float: right">签字：</p>
        </li>
    </ul>
</div>
</div>

<div id="changeSpeed" class="easyui-dialog" title="修改进度" closed=true >
    <ul style="width:370px">
        <li>
            <span>修 改 进 度：</span>
            <input type="text" name="changeSpeed" title="请输入1-100数字" min="1" max="100" value="1"
                   onkeyup="if(isNaN($(this).val())){$(this).val('')} if($(this).val()>100||$(this).val()<0){$(this).val('')}">
        </li>
        <li>
            <span>任 务 阶 段：</span>
            <select name="" id="taskStage" style="font-size: 18px">
                <option value="外业进行">外业进行</option>
                <option value="内业进行">内业进行</option>
                <option value="质量检测">质量检测</option>
            </select>
        </li>
        <li style="margin: 20px auto">
            <input type="button" class="button-task" value="确 认 提 交" onclick="changeSpeed()" />
        </li>
    </ul>
</div>


<script type="text/javascript">

    //初始化弹窗 查看任务
    function viewTask() {
        var viewTask = $('#viewTeskDg').datagrid('getSelected');
        if (viewTask) {
            $('#viewTask').dialog({
                width: 800,
                height:550,
                top:50,
                closed: false, //更改 显示隐藏
                cache: false,//是否缓存
                onOpen: function () {
                    $("input[name = userid]").val(viewTask.id);
                    $("input[name = userName]").val(viewTask.userName);
                    $("input[name = recipient]").val(viewTask.recipient);
                    $("input[name = implement]").val(viewTask.implement);
                    $("input[name = taskAddress]").val(viewTask.taskAddress);
                    $("input[name = entrustedUnit]").val(viewTask.entrustedUnit);
                    $("input[name = client]").val(viewTask.client);
                    $("input[name = clientPhone]").val(viewTask.clientPhone);
                    $("input[name = taskPhase]").val(viewTask.taskPhase);
                    $("input[name = inspection]").val(viewTask.inspection);
                    $("input[name = implementDate]").val(viewTask.implementDate);
                    $("input[name = successDate]").val(viewTask.successDate);
                    $("input[name = taskDate]").val(viewTask.taskDate);
                    $("input[name = taskTheme]").val(viewTask.taskTheme);
                    $("input[name = inspectionUser]").val(viewTask.inspectionUser);
                    $("input[name = state]").val(viewTask.state);
                    $("textarea[name = taskText]").val(viewTask.taskText);
                    $('#speedTask').progressbar({
                        value: viewTask.speed
                    });
                    $('#speedTask2').progressbar({
                        value: viewTask.speed
                    });
                }
            });
        } else {
            $.messager.alert("提示", "请选择一条数据", "info");
        }
    }

    //初始化表格  任务表格
    $('#viewTeskDg').datagrid({
        url: 'task/queryOwn.action',
        method: 'POST',
        pagination: true,
        singleSelect: true,  //仅可以选中一行
        toolbar: "#buttonBarOwn",  //使上方控制器和表格融为一体
        columns: [[
            {field: 'id', title: '编号', checkbox: true},
            {field: 'taskTheme',title: '任务主题'},
            {field: 'taskText',title: '任务内容',width:200},
            {field: 'userName',title: '发布人'},
            {field: 'taskAddress',title: '项目地址',hidden:true},
            {field: 'entrustedUnit',title: '委托单位',hidden:true},
            {field: 'client',title: '委托人',hidden:true},
            {field: 'clientPhone',title: '委托人联系电话',hidden:true},
            {field: 'taskDate',title: '任务发布日期',width:100},
            {field: 'recipient',title: '接收人',width:100},
            {field: 'implement', title: '执行人',width:100},
            {field: 'inspectionUser', title: '质检人',width:100},
            {field: 'implementDate', title: '任务开始时间',width:100},
            {field: 'successDate', title: '任务结束时间',width:100},
            {
                field: 'speed', title: '任务进度', formatter: function (value) {
                var htmlstr = '<div class="easyui-progressbar progressbar" style="width: 300px; height: 20px;" value="' + value + '" text="' + value + '%">' +
                        '<div class="progressbar-text" style="width: 300px; height: 20px; line-height: 20px;">' + value + '%</div>' +
                        '<div class="progressbar-value" style="width: ' + value + '%; height: 20px; line-height: 20px;">' +
                        '<div class="progressbar-text" style="width: 300px; height: 20px; line-height: 20px;">' + value + '%</div>' +
                        '</div>' +
                        '</div>';
                return htmlstr;

            	}, width:330
            },
            {field: 'taskPhase', title: '任务阶段',width:100},
            {field: 'inspection', title: '质检检测',width:100},
            {field: 'state', title: '任务状态',width:100}
        ]]
    });

    //提交
    function acceptTask() {
    	var row=$('#viewTeskDg').datagrid('getSelected');
    	var taskId=row.id;
    	if(row.state=="已下达"){
	        $.ajax({
	            url: "task/acceptTask.action",
	            method: "POST",
	            data: {
	                taskId: $("input[name = userid]").val()
	            },
	            success: function (data) {
	                if (data > 0) {
	                    $.messager.alert("提示", "接收任务成功", "info");
	                    $('#viewTask').dialog({
	                        closed: true //更改 显示隐藏
	                    });
	                    $('#viewTeskDg').datagrid("reload");
					   	$("#listMes li").each(function(){
					   		 var target=$(this).attr("id");
					   		 if(target==taskId){
					   		 	 $(this).remove(); 
					   		 	var number =$("#listMes").children('li').length;
					   		 	if(number==0){
					   		 	 $("#message").hide();  
					   		 	}
					   		 }
					   	})
	                } else {
	                    $.messager.alert("提示", "接收任务失败", "info")
	                }
	            }
	        })
    	}else{
    		 $.messager.alert("提示", "只能接收已下达任务", "info");
    	}
    }


    //进度修改弹窗
    function changeSpeedDig() {
        var SpeedData = $('#viewTeskDg').datagrid('getSelected');
        if(SpeedData){
            if (SpeedData.state=="已接收") {
                $('#changeSpeed').dialog({
                    closed: false,
                    width:500
                })
            } else {
                $.messager.alert("提示", "请先接收任务", "info");
            }
        }else{
            $.messager.alert("提示", "请先选择任务", "info");
        }
    }


    //    提交修改任务进度
    function changeSpeed() {
    	var row2= $('#viewTeskDg').datagrid('getSelected');
    	var speed=$("input[name='changeSpeed']").val();
        $.ajax({
            url: "task/updateTaskSpeed.action",
            method: "POST",
            data: {
            	taskId: row2.id,
                speed: $("input[name = changeSpeed]").val(),
                taskPhase:$("#taskStage").find("option:selected").text()
            },
            success: function (data) {
                if (data > 0) {
                    $.messager.alert("提示", "修改进度成功", "info");
                    $('#changeSpeed').dialog({
                        closed: true //更改 显示隐藏
                    });
                    $('#viewTeskDg').datagrid("reload");
                } else {
                    $.messager.alert("提示", "修改进度失败", "info")
                }
            }
        })

    }
    $('.PrintK').css({"display":"block"});
    $('.PrintK').width($(window).width());
    $('.PrintK').height("1400px");
    var maxWidth=$(window).width();
    if(maxWidth>1280){

    }else if(maxWidth<1280){
        $('.PrintK ul').css({"margin-left":"140px"});
    }else if(maxWidth<1024){
        $('.PrintK ul').css({"margin-left":"30px"});
    }
    function ownTaskPrint(){
        $("#viewTask2").dialog({
            closed: false,
            width:$(window).width(),
            height:1400,
            resizable:true,
            left:0,
            top:0,
            border:false
        })
    }
    function Qprint(){
        window.print()
    }
    function Uprint(){
        $("#viewTask2").dialog({
            closed: true
        })
    }
</script>
</body>
</html>