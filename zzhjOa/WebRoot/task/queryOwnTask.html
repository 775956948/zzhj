<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>下达任务</title>
</head>
<body>
<div class="PagingBody">
    <h3>下 达 任 务</h3>
    <div id="viewTaskOWN" class="easyui-dialog" title="查看任务" closed=true>
        <ul>
            <li style="height: 40px;margin-top: 20px">
                <div class="splitLi">
                    <span>任 务 主 题：</span>
                    <input type="text" name="CotaskTheme" readonly="readonly" >
                </div>
                <div class="splitLi">
                    <span>发 &nbsp 布 &nbsp 人：</span>
                    <input type="text" name="CouserName" readonly>
                </div>
            </li>
            <li style="height: 40px">
                <div class="splitLi">
                    <span>发 布 日 期：</span>
                    <input type="text" name="CotaskDate" readonly>
                </div>
            </li>
            <li>
                <div class="splitLi" style="width: 102%">
                    <span>项 目 地 址：</span>
                    <input type="text" name="CotaskAddress" readonly style="width: 70%">
                </div>
            </li>
            <li style="height: 40px" >
                <div class="splitLi" style="width: 102%">
                    <span>委 托 单 位：</span>
                    <input type="text" name="CoentrustedUnit" readonly style="width: 70%">
                </div>
            </li>
            <li style="height: 40px">
                <div class="splitLi">
                    <span>委 &nbsp 托 &nbsp 人：</span>
                    <input type="text" name="Coclient" readonly>
                </div>
                <div class="splitLi">
                    <span>委托人电话：</span>
                    <input type="text" name="CoclientPhone" readonly>
                </div>
            </li>
            <li style="height: 40px">
                <div class="splitLi">
                    <span>任务接收人：</span>
                    <input type="text" name="Corecipient" readonly>
                </div>
                <div class="splitLi">
                    <span>任务执行人：</span>
                    <input type="text" name="Coimplement" readonly>
                </div>
            </li>
            <li style="height: 40px">
                <div class="splitLi">
                    <span>任务开始时间：</span>
                    <input type="text" name="CoimplementDate" readonly>
                </div>
                <div class="splitLi">
                    <span>任务结束时间：</span>
                    <input type="text" name="CosuccessDate" readonly>
                </div>
            </li>
            <li>
                <div class="splitLi">
                    <span>指定结束时间：</span>
                    <input type="text" name="CooverDate" readonly>
                </div>
            </li>
            <li>
                <span style="float: left">任 务 进 度：</span>
                <div id="CospeedTask" class="easyui-progressbar" style="width:71%; height:38px"></div>
            </li>
            <li>
                <div class="splitLi">
                    <span>任 务 状 态：</span>
                    <input type="text" name="Costate" readonly >
                </div>
                <div class="splitLi">
                    <span>质 &nbsp 检 &nbsp 人：</span>
                    <input type="text" name="CoinspectionUser" readonly >
                </div>
            </li>
            <li style="height: 40px">
                <div class="splitLi">
                    <span>任 务 阶 段：</span>
                    <input type="text" name="CotaskPhase" readonly>
                </div>
                <div class="splitLi">
                    <span>质 量 检 测：</span>
                    <input type="text" name="Coinspection" readonly>
                </div>
            </li>
            <li>
                <span style="position: absolute;top: 29%;">任 务 内 容：</span>
                <textarea name="CotaskText" rows="7" cols="30" style="width: 70%;margin-left: 118px" readonly></textarea>
            </li>
        </ul>
    </div>
</div>
<div id="changeTime" class="easyui-dialog" title="修改任务周期" closed=true>
    <ul style="width: 300px;margin: 20px auto">
        <li>
            <input type="hidden" name="taskIdtime">
        </li>
        <li style="margin: 20px auto;height: 40px" >
            <span>任务开始时间：</span>
            <input type="text" name="implementDate" class="easyui-datebox" id="implementDateChange" style="height: 90%;text-align: center" >
        </li>
        <li style="margin: 20px auto;height: 40px" >
            <span>任务结束时间：</span>
            <input type="text" name="successDate" class="easyui-datebox" id="successDateChange" style="height: 90%;text-align: center">
        </li>
        <li style="margin: 20px auto;height: 40px" >
            <span>指定结束时间：</span>
            <input type="text" name="overDate" readonly id="overDateChange" style="height: 90%;text-align: center">
        </li>
        <li style="margin: 20px auto">
            <input type="button" class="button-task"  onclick="changeTime()" value="确 认 更 改">
        </li>
    </ul>
</div>

<div id="taskTb">
    <a class="easyui-linkbutton" iconCls="icon-xd" plain="true" onclick="transmitTaskOpen()">下达任务</a>
    <a class="easyui-linkbutton" iconCls="icon-gr" plain="true" onclick="viewTaskXOWN()">查看任务</a>
    <a class="easyui-linkbutton" iconCls="icon-xg" plain="true" onclick="changeTimeDg()">修改时间</a>
</div>
<div id="taskDd" class="easyui-dialog" closed=true>
    <form id="transmitForm">
        <ul>
            <li>
                <input type="hidden" name="QotaskId">
            </li>
            <li style="">
                <div class="splitLi">
                    <span>任 &nbsp 务  主 &nbsp 题：</span>
                    <input type="text" name="QotaskTheme" readonly="readonly">
                </div>
            <li>
            <span style="position: absolute;top: 29%;">任  &nbsp务 内 &nbsp 容：</span>
            <textarea name="QotaskText" rows="7" cols="30" style="width: 70%;margin-left: 118px" readonly></textarea>
            </li>
            <li>
                <div class="splitLi">
                    <span>  &nbsp 发 &nbsp 布 &nbsp  人 &nbsp：</span>
                    <input type="text" name="QouserName" readonly>
                </div>
            </li>
            <li style="">
                <div class="splitLi">
                    <span>任务开始时间：</span>
                    <input type="text" name="QoimplementDate" class="easyui-datebox" id="implementDate" >
                </div>
            </li>
            <li style="">
                <div class="splitLi">
                    <span>任务结束时间：</span>
                    <input type="text" name="QosuccessDate" class="easyui-datebox" id="successDate">
                </div>
            </li>
            <li style="">
                <div class="splitLi">
                    <span>指定结束时间：</span>
                    <input type="text" name="QooverDate" readonly  id="overDate">
                </div>
            </li>
            <li style="height: 40px">
                <div class="splitLi">
                    <span>任 务 执 行 人：</span>
                    <select name="Qoimplement" style="font-size: 18px"></select>
                </div>
            </li>
            <li style="margin: 20px auto">
                <input type="button" class="button-task" onclick="transmitTask()" value="确 认 下 达">
            </li>
        </ul>
    </form>
</div>

<table id="teskDg"></table>

<script type="text/javascript">
    function viewTaskXOWN() {
        var viewTaskOwn = $('#teskDg').datagrid('getSelected');
        if (viewTaskOwn) {
            $('#viewTaskOWN').dialog({
                width: 800,
                height:550,
                top:50,
                closed: false, //更改 显示隐藏
                cache: false,//是否缓存
                onOpen: function () {
                    $("input[name = CouserName]").val(viewTaskOwn.userName);
                    $("input[name = Corecipient]").val(viewTaskOwn.recipient);
                    $("input[name = Coimplement]").val(viewTaskOwn.implement);
                    $("input[name = CotaskAddress]").val(viewTaskOwn.taskAddress);
                    $("input[name = CoentrustedUnit]").val(viewTaskOwn.entrustedUnit);
                    $("input[name = Coclient]").val(viewTaskOwn.client);
                    $("input[name = CoclientPhone]").val(viewTaskOwn.clientPhone);
                    $("input[name = CotaskPhase]").val(viewTaskOwn.taskPhase);
                    $("input[name = Coinspection]").val(viewTaskOwn.inspection);
                    $("input[name = CoimplementDate]").val(viewTaskOwn.implementDate);
                    $("input[name = CosuccessDate]").val(viewTaskOwn.successDate);
                    $("input[name = CooverDate]").val(viewTaskOwn.overDate);
                    $("input[name = CotaskDate]").val(viewTaskOwn.taskDate);
                    $("input[name = CotaskTheme]").val(viewTaskOwn.taskTheme);
                    $("input[name = Costate]").val(viewTaskOwn.state);
                    $("input[name = CoinspectionUser]").val(viewTaskOwn.inspectionUser);
                    $("textarea[name = CotaskText]").val(viewTaskOwn.taskText);
                    $('#CospeedTask').progressbar({
                        value: viewTaskOwn.speed
                    });
                }
            });
        } else {
            $.messager.alert("提示", "请选择一条数据", "info");
        }
    }

    $('#successDate').datebox({
        required:true,
        editable:false
    });
    $('#implementDate').datebox({
        required:true,
        editable:false
    });
    $('#successDateChange').datebox({
        required:true,
        editable:false
    });
    $('#implementDateChange').datebox({
        required:true,
        editable:false
    });

    $('#teskDg').datagrid({
        url: 'task/queryOwn.action',
        toolbar: '#taskTb',
        pagination: true,
        singleSelect: true,
        columns: [[
            {field: 'id', title: '编号', checkbox: true},
            {field: 'taskTheme',title: '任务主题'},
            {field: 'taskText',title: '任务内容',width:200},
            {field: 'userName',title: '发布人'},
            {field: 'taskAddress',title: '项目地址',hidden:true},
            {field: 'entrustedUnit',title: '委托单位',hidden:true},
            {field: 'client',title: '委托人',hidden:true},
            {field: 'clientPhone',title: '委托人联系电话',hidden:true},
            {field: 'taskDate',title: '任务发布日期',width:100},
            {field: 'recipient',title: '接收人',width:100},
            {field: 'implement', title: '执行人',width:100},
            {field: 'inspectionUser', title: '质检人',width:100},
            {field: 'implementDate', title: '任务开始时间',width:100},
            {field: 'successDate', title: '任务结束时间',width:100},
            {field: 'overDate', title: '指定结束时间',width:100},
            {
                field: 'speed', title: '任务进度', formatter: function (value) {
                var htmlstr = '<div class="easyui-progressbar progressbar" style="width: 300px; height: 20px;" value="' + value + '" text="' + value + '%">' +
                        '<div class="progressbar-text" style="width: 300px; height: 20px; line-height: 20px;">' + value + '%</div>' +
                        '<div class="progressbar-value" style="width: ' + value + '%; height: 20px; line-height: 20px;">' +
                        '<div class="progressbar-text" style="width: 300px; height: 20px; line-height: 20px;">' + value + '%</div>' +
                        '</div>' +
                        '</div>';
                return htmlstr;
            }, width: 330
            },
            {field: 'taskPhase', title: '任务阶段'},
            {field: 'inspection', title: '质检检测'},
            {field: 'state', title: '任务状态'}
        ]]
    });

    function transmitTaskOpen() {
        var row = $('#teskDg').datagrid('getSelected');
        if (row) {
        	if(row.state=="已发布"){
	            $("#taskDd").dialog({
	                title: '任务信息',
//	                height: 500,
                    top:18,
	                closed: false,
	                onOpen: function () {
	                    $.post('users/querySubclass.action', function (data) {
	                        $("#transmitForm select[name='Qoimplement']").empty();
	                        for (var i = 0; i < data.length; i++) {
	                            $("#transmitForm select[name='Qoimplement']").append("<option>" + data[i] + "</option>")
	                        }
	                    });
                        $("input[name='QotaskId']").val(row.id);
                        $("input[name='QotaskTheme']").val(row.taskTheme);
                        $("input[name='QouserName']").val(row.userName);
                        $("#successDate").datebox('setValue',row.successDate);
                        $("#implementDate").datebox('setValue',row.implementDate);
                        $("#overDate").val(row.overDate);
                        $("textarea[name='QotaskText']").val(row.taskText);
	                }
	            })
        	}else{
        		 $.messager.alert("提示", "只能下达已发布任务", "info");
        	}
        } else {
            $.messager.alert("提示", "请选中一条信息", "info");
        }
    }
    function changeTimeDg() {
        var row = $('#teskDg').datagrid('getSelected');
        if (row) {
                $("#changeTime").dialog({
                    top:50,
                    closed: false,
                    onOpen: function () {
                        $("#successDateChange").datebox('setValue',row.successDate);
                        $("#implementDateChange").datebox('setValue',row.implementDate);
                        $("#overDateChange").val(row.overDate);
                    }
                })
        } else {
            $.messager.alert("提示", "请选中一条已发布任务", "info");
        }
    }
    function changeTime() {
        var row = $('#teskDg').datagrid('getSelected');
        var ZDtime = $("#overDateChange").val().split("-").join("");
        var Changetime = $("#successDateChange").val().split("-").join("");
        if (Changetime > ZDtime || $("#implementDateChange").val() == "") {
            $.messager.alert("提示", "请正确填写时间范围！", "info")
        } else {
            $.post('task/updateTaskTime.action', {
                'id': row.id,
                'successDate': $("#successDateChange").val(),
                'implementDate': $("#implementDateChange").val()
            }, function (data) {
                if (data > 0) {
                    $.messager.alert("提示", "任务周期更改成功！", "info");
                    $("#changeTime").dialog({
                        closed: true
                    });
                    $('#teskDg').datagrid('reload');
                }
            })
        }
    }

    function transmitTask() {
        var number = 0;
        if($("#implementDate").val()==""||$("#successDate").val()==""||$("select[name=Qoimplement]").find("option:selected").text()==""){
            number=number+1;
        }
        var row = $('#teskDg').datagrid('getSelected');
        var NsuccessDate=$("#successDate").val().split("-").join("");
        var ZDoverDate=$("#overDate").val().split("-").join("");
        if(NsuccessDate>ZDoverDate){
            $.messager.alert("提示","请在原有时间范围内修改","info");
            $("#successDate").datebox('setValue',row.successDate);
        }else {
            if (number == 0) {
            	var  implementDate= $("#implementDate").val();
            	var successDate = $("#successDate").val();
                var id = $("input[name=QotaskId]").val();
                var implement = $("select[name=Qoimplement]").find("option:selected").text();
                $.post('task/transmitTask.action', {'taskId': id, 'implement': implement,'implementDate':implementDate,'successDate':successDate}, function (data) {
                    if (data > 0) {
                        $.messager.alert("提示", "下达成功", "info");
                        $("#taskDd").dialog({
                            closed: true
                        })
                        $('#teskDg').datagrid('reload');
                        //
                        $("#listMes li").each(function () {
                            var target = $(this).attr("id");
                            if (target == id) {
                                $(this).remove();
                                var number = $("#listMes").children('li').length;
                                if (number == 0) {
                                    $("#message").hide();
                                }
                            }
                        })
                    }
                })

            } else {
                $.messager.alert("提示", "信息不完整", "info");
            }
        }
    }
</script>
</body>
</html>