<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>下达任务</title>
</head>
<body>
<div class="PagingBody">
    <h3>下 达 任 务</h3>
</div>
<div id="taskTb">
    <a class="easyui-linkbutton" iconCls="icon-xd" plain="true" onclick="transmitTaskOpen()">下达任务</a>
</div>
<div id="taskDd" class="easyui-dialog" closed=true>
    <form id="transmitForm">
        <ul>
            <li>
                <input type="hidden" name="taskId">
            </li>
            <li style="height: 40px">
                <div class="splitLi">
                    <span>任 务 主 题：</span>
                    <input type="text" name="taskTheme" readonly="readonly">
                </div>
            <li>
                <span style="position: absolute;top: 29%;">任 务 内 容：</span>
                <textarea name="taskText" rows="7" cols="30" style="width: 70%;margin-left: 95px" readonly></textarea>
            </li>
            <li>
                <div class="splitLi">
                    <span>发 &nbsp 布 &nbsp 人：</span>
                    <input type="text" name="userName" readonly>
                </div>
            </li>
            <li style="height: 40px">
                <div class="splitLi">
                    <span>任 务 天 数：</span>
                    <input type="text" name="taskDay" readonly>
                </div>
            </li>
            <li style="height: 40px">
                <div class="splitLi">
                    <span>任务执行人：</span>
                    <select name="implement"></select>
                </div>
            </li>
            <li style="margin: 20px auto">
                <button onclick="transmitTask()">确 认 下 达</button>
            </li>
        </ul>
    </form>
</div>
<table id="teskDg"></table>

<script type="text/javascript">
    $('#teskDg').datagrid({
        url: 'task/queryOwn.action',
        fitColumns: true,
        toolbar: '#taskTb',
        pagination: true,
        singleSelect: true,
        columns: [[
            {field: 'id', title: '编号', checkbox: true, width: 200},
            {field: 'taskTheme', title: '任务主题', width: 200},
            {field: 'taskText', title: '任务内容'},
            {field: 'userName', title: '发布人'},
            {field: 'taskDay', title: '任务天数'},
            {field: 'taskDate', title: '任务发布日期', width: 100},
            {field: 'recipient', title: '接收人'},
            {field: 'implement', title: '执行人'},
            {field: 'implementDate', title: '任务开始时间', width: 100},
            {field: 'successDate', title: '任务完成时间', width: 100},
            {
                field: 'speed', title: '任务进度', formatter: function (value) {
                var htmlstr = '<div class="easyui-progressbar progressbar" style="width: 300px; height: 20px;" value="' + value + '" text="' + value + '%">' +
                        '<div class="progressbar-text" style="width: 300px; height: 20px; line-height: 20px;">' + value + '%</div>' +
                        '<div class="progressbar-value" style="width: ' + value + '%; height: 20px; line-height: 20px;">' +
                        '<div class="progressbar-text" style="width: 300px; height: 20px; line-height: 20px;">' + value + '%</div>' +
                        '</div>' +
                        '</div>';
                return htmlstr;
            }, width: 400
            },
            {field: 'state', title: '任务状态'}
        ]]
    });

    function transmitTaskOpen() {
        var row = $('#teskDg').datagrid('getSelected');
        if (row) {
            $("#taskDd").dialog({
                title: '任务信息',
                width: 400,
                height: 400,
                closed: false,
                onOpen: function () {
                    $.post('users/querySubclass.action', function (data) {
                        $("#transmitForm select[name='implement']").empty();
                        for (var i = 0; i < data.length; i++) {
                            $("#transmitForm select[name='implement']").append("<option>" + data[i] + "</option>")
                        }
                    })
                    $("input[name='taskId']").val(row.id);
                    $("input[name='taskTheme']").val(row.taskTheme);
                    $("input[name='userName']").val(row.userName);
                    $("input[name='taskDay']").val(row.taskDay);
                    $("textarea[name='taskText']").val(row.taskText);
                }
            })
        } else {
            $.messager.alert("提示", "请选中一条信息", "info");
        }
    }

    function transmitTask() {
        var number = 0;
        $("#transmitForm input,textarea").each(function () {
            var val = $(this).val();
            if (val == "" || val == undefined || val == null) {
                number = number + 1;
            }
        })
        if (number == 0) {
            var id = $("input[name='taskId']").val();
            var implement = $("select[name='implement']").find("option:selected").text();
            $.post('task/transmitTask.action', {'taskId': id, 'implement': implement}, function (data) {
                if (data > 0) {
                    $.messager.alert("提示", "下达成功", "info");
                    $("#taskDd").dialog({
                        closed: true
                    })
                    $('#taskDd').datagrid('reload');
                }
            })

        } else {
            $.messager.alert("提示", "信息不完整", "info");
        }
    }

</script>

</body>
</html>